#include "kernel.h"
#include "x86.h"
#include "vm.h"
#include "irq.h"
#include "driver/hal.h"
#include "driver/term.h"
#include "driver/time.h"
#include "driver/tty.h"

extern char code[];

void
idle(){
    while(1){
        wait_intr();
    }
}

void
echo() {
	static int tty = 1;
	char name[] = "tty*", buf[256];
    printk("init buf_addr %x\n",buf);
	Device *dev;
	lock();
	name[3] = '0' + (tty ++);
	unlock();
	while (1) {
		dev = hal_get(name);
		if (dev != NULL) {
			dev_write(dev, 0, name, 4);
			dev_write(dev, 0, "# ", 2);
			int i, nread = dev_read(dev, 0, buf, 255);
			buf[nread] = 0;
			for (i = 0; i < nread; i ++) {
				if (buf[i] >= 'a' && buf[i] <= 'z') {
					buf[i] += 'A' - 'a';
				}
			}
            printk("buf:%s\n",buf);
			dev_write(dev, 0, "Got: ", 5);
			dev_write(dev, 0, buf, nread);
			dev_write(dev, 0, "\n", 1);
		} else {
			printk("%s\n", name);
		}
	}
}

void
test() {
	int i;
	for (i = 0; i < NR_TTY; i ++) {
		wakeup(create_kthread(echo));
	}
}

void
os_init(void) {
    init_seg();
    init_debug();
    init_idt();
    init_i8259();
    queue_init();
    hashtb_init();
    printk("The OS is now working!\n");
    init_hal();
    init_timer();
    init_tty();
    wakeup(create_kthread(idle));
    PCB * p = create_kthread(ttyd);
    TTY = p->pid;
    wakeup(p);
    test();
    wakeup(create_uprocess((struct ELFHeader *)&code));
    printk("enable intrupt\n");
    sti();
    while (TRUE) {
        wait_intr();
    }
}

void
entry(void) {
    init_kvm();
    void(*volatile next)(void) = os_init;
    asm volatile("addl %0, %%esp" : : ""(KOFFSET));
    next();
    panic("init code should never return");
}

char code[] = {
    0x7f,0x45,0x4c,0x46,0x1,0x1,0x1,0x0,
    0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x2,0x0,0x3,0x0,0x1,0x0,0x0,0x0,
    0x74,0x80,0x4,0x8,0x34,0x0,0x0,0x0,
    0x14,0x1,0x0,0x0,0x0,0x0,0x0,0x0,
    0x34,0x0,0x20,0x0,0x2,0x0,0x28,0x0,
    0x7,0x0,0x4,0x0,0x1,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x0,0x80,0x4,0x8,
    0x0,0x80,0x4,0x8,0xb4,0x0,0x0,0x0,
    0xb4,0x0,0x0,0x0,0x5,0x0,0x0,0x0,
    0x0,0x10,0x0,0x0,0x51,0xe5,0x74,0x64,
    0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x6,0x0,0x0,0x0,
    0x4,0x0,0x0,0x0,0x55,0x89,0xe5,0xb8,
    0x80,0x80,0x0,0x0,0xcd,0x80,0xeb,0xf7,
    0x14,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x1,0x7a,0x52,0x0,0x1,0x7c,0x8,0x1,
    0x1b,0xc,0x4,0x4,0x88,0x1,0x0,0x0,
    0x18,0x0,0x0,0x0,0x1c,0x0,0x0,0x0,
    0xd4,0xff,0xff,0xff,0xc,0x0,0x0,0x0,
    0x0,0x41,0xe,0x8,0x85,0x2,0x42,0xd,
    0x5,0x0,0x0,0x0,0x47,0x43,0x43,0x3a,
    0x20,0x28,0x55,0x62,0x75,0x6e,0x74,0x75,
    0x2f,0x4c,0x69,0x6e,0x61,0x72,0x6f,0x20,
    0x34,0x2e,0x36,0x2e,0x33,0x2d,0x31,0x75,
    0x62,0x75,0x6e,0x74,0x75,0x35,0x29,0x20,
    0x34,0x2e,0x36,0x2e,0x33,0x0,0x0,0x2e,
    0x73,0x79,0x6d,0x74,0x61,0x62,0x0,0x2e,
    0x73,0x74,0x72,0x74,0x61,0x62,0x0,0x2e,
    0x73,0x68,0x73,0x74,0x72,0x74,0x61,0x62,
    0x0,0x2e,0x74,0x65,0x78,0x74,0x0,0x2e,
    0x65,0x68,0x5f,0x66,0x72,0x61,0x6d,0x65,
    0x0,0x2e,0x63,0x6f,0x6d,0x6d,0x65,0x6e,
    0x74,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x1b,0x0,0x0,0x0,
    0x1,0x0,0x0,0x0,0x6,0x0,0x0,0x0,
    0x74,0x80,0x4,0x8,0x74,0x0,0x0,0x0,
    0xc,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x4,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x21,0x0,0x0,0x0,
    0x1,0x0,0x0,0x0,0x2,0x0,0x0,0x0,
    0x80,0x80,0x4,0x8,0x80,0x0,0x0,0x0,
    0x34,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x4,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x2b,0x0,0x0,0x0,
    0x1,0x0,0x0,0x0,0x30,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0xb4,0x0,0x0,0x0,
    0x2a,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x1,0x0,0x0,0x0,
    0x1,0x0,0x0,0x0,0x11,0x0,0x0,0x0,
    0x3,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0xde,0x0,0x0,0x0,
    0x34,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x1,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x1,0x0,0x0,0x0,
    0x2,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x2c,0x2,0x0,0x0,
    0x90,0x0,0x0,0x0,0x6,0x0,0x0,0x0,
    0x5,0x0,0x0,0x0,0x4,0x0,0x0,0x0,
    0x10,0x0,0x0,0x0,0x9,0x0,0x0,0x0,
    0x3,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0xbc,0x2,0x0,0x0,
    0x26,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x1,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x74,0x80,0x4,0x8,0x0,0x0,0x0,0x0,
    0x3,0x0,0x1,0x0,0x0,0x0,0x0,0x0,
    0x80,0x80,0x4,0x8,0x0,0x0,0x0,0x0,
    0x3,0x0,0x2,0x0,0x0,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x3,0x0,0x3,0x0,0x1,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x4,0x0,0xf1,0xff,0x9,0x0,0x0,0x0,
    0xb4,0x90,0x4,0x8,0x0,0x0,0x0,0x0,
    0x10,0x0,0xf1,0xff,0x15,0x0,0x0,0x0,
    0x74,0x80,0x4,0x8,0xc,0x0,0x0,0x0,
    0x12,0x0,0x1,0x0,0x1a,0x0,0x0,0x0,
    0xb4,0x90,0x4,0x8,0x0,0x0,0x0,0x0,
    0x10,0x0,0xf1,0xff,0x21,0x0,0x0,0x0,
    0xb4,0x90,0x4,0x8,0x0,0x0,0x0,0x0,
    0x10,0x0,0xf1,0xff,0x0,0x68,0x65,0x6c,
    0x6c,0x6f,0x2e,0x63,0x0,0x5f,0x5f,0x62,
    0x73,0x73,0x5f,0x73,0x74,0x61,0x72,0x74,
    0x0,0x6d,0x61,0x69,0x6e,0x0,0x5f,0x65,
    0x64,0x61,0x74,0x61,0x0,0x5f,0x65,0x6e,
    0x64,0x0
};

